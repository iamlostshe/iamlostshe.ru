---
description: копаюсь в скидочных картах
---

# копаюсь в скидочных картах

эта идея была отражена в [планах](/blog/ideas), до реализации. заглядывай, там ещё много чего интересного.

## введение

у меня в избранном уже несколько лет лежат фотографии скидочных карт нескольких магазинов.

удобно, ничего не нужно с собой носить, кроме, телефона (изменено: перешёл на кнопочный телефон, теперь не удобно).

при использовании появилась идея организовать все свои карты в одном месте: сделать **мини-приложение-катхолдер** для скидочных карт, с красивым `gui`, чтобы было не стыдно показывать его на кассе.

да и в целом будет интересно покопаться в `api` магазинов, узнать как там дела с безопасностью.

## аудит баркода

начну с анализа бар-кода из приложения. нужно разобраться что за тип бар-кода они используют.

первым в голову пришло просто спросить у gpt, прикрепив изображение, но это не дало результатов.

потом, я просто решил открыть картинки по запросу "типы бар-код" и найти похожий.

оказалось, что они используют формат [PDF417](https://ru.wikipedia.org/wiki/PDF417) (не путать с форматом документа). при декодировании мы получаем что-то подобное:

```
X - цифра от 1 до 9.

XXXX XXXX XXXX XXXX QR XXXXXXXXXX
^^^^^^^^^^^^^^^^^^^    ^^^^^^^^^^
         1                 2

X - цифра от 1 до 9.

1 - номер карты (16 символов).
2 - случайный код, обновляется при входе в приложение/обновлении страницы.
```

> интересно, что бар-коды такого формата могут вмещать до 2710 символов, однако, магазин не использует всего потенциала.

## копаюсь в api

итак, теперь нам нужен какой-то минимальный `api-wraper` для получения баланса карты, желательно, просто, по номеру.

интересно, что бар-код не отображается на пк, предполагаю, что в целях безопасности, чтобы нельзя было посмотреть через dev tools (да и сложно представить сценарий, когда это нужно будет).

хорошо, что мы умеем анализировать запросы, на телефоне.

легко вытаскивается следующий эндпоинт (данные анонимизированы):

```
https://example.com/api/cards/cards.CardsService/GetBalance/<номер карты>
```

обязательным условием для работы с ним является авторизация, через bearer token.

если попытаться использовать с картой, не пренадлежащей пользователю, сервер возвращает ошибку:

``` json
{
	"error": {
		"status_code": 493,
		"code": "1107",
		"message": "",
		"debug": ""
	}
}
```

ни `493`, ни `1107` не являются стандартными статус-кодами, открытого `openapi` / `swagger`-а я не нашёл, поэтому, предполагаю, что доступ запрещён.

## рассуждаю о формате бота

получается, у перед нами встаёт выбор:

### 1. `self-hosted` архитектура

при которой пользователь, которому необходим картхолдер:

- клонирует исходный код.
- арендует сервер.
- покупает домен (telegram требует https для mini-приложений => нужно пробросить сертификаты => нужен домен).
- копается в dev tools-ах браузера (token можно получить на пк).
- настраивает систему через терминал.

сразу понятно, что рядовой пользователь такого не осилит, да и не будет смысла этим заниматься, ради простого хранения карт.

### 2. бот с публичной (общей) картой.

у этого способа, также, определённо есть минусы, например, любой пользователь может списать бонусы.

но есть минус и потяжелее: **у карт, есть лимит использования за день**.

мы можем нивелировать лимит, если распределим трафик по нескольким картам, тем более, в нашем подчинении `api`, мы можем отслеживать суммы и кол-во операций по каждой карте.

интересно, можно ли как-то проверить, не вышел ли лимит использования карты, напрямую, из api?

скорее всего - нет, в ответе `api` нет прямого упоминания limit-а, однако, есть следующий поля, в назначении которых я не разобрался:

``` yaml
"cardStatus": "ACTIVE"
"master": true
```
