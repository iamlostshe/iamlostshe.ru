---
description: Как я разрабатывал собственную временную почту
tags: grey
habr_link: https://habr.com/ru/articles/946680/
---

# Как я разрабатывал собственную временную почту

Мне нужно написать скрипт **авторега аккаунтов** для одного популярного сервиса. Для регистрации аккаунтов нужна электронная почта. Логичным решением было использовать **временные почты**.

Ранее (~1.5 года назад) я уже использовал для таких задач python-библиотеку [tempmail](https://github.com/cubicbyte/tempmail-python), но она [перестала работать](https://github.com/cubicbyte/tempmail-python/issues/13).

В моей [issue](https://github.com/cubicbyte/tempmail-python/issues/13) к [tempmail](https://github.com/cubicbyte/tempmail-python) предложили [альтернативу](https://github.com/MainSilent/MailTm).

Но в связи с устаревшими решениями по коду я решил [форкнуть](https://github.com/iamlostshe/mail-tm) либу. Оказалось, что механизм библиотеки достаточно прост - она использует [открытые api](https://api.mail.tm/) mail.tm.

Проведя небольшой ресёрч в интернете я нашел mail.gw, который выглядит/работает также, как mail.tm и с которым, как оказалось, уже может работать [мой форк](https://github.com/iamlostshe/mail-tm).

Но, есть проблема: при регистрации аккаунта сервис легко обнаруживает временные почты (предположительно, по черному списку доменов, но у меня есть решение, расскажу в конце).

Значит нам предстоит развернуть собственный сервер временной электронной почты на собственном домене.

Исходный код сервера mail.tm и mail.gw (предположительно) был опубликован на GitHub. По крайней мере так было с [документацией](https://docs.mail.tm/), но с 2022 года или ранее недоступен (определил по архивным копиям).

Запрос на почты поддержки (support@mail.tm, support@mail.qw), в [дс/тг](https://discord.com/invite/mail) не дал результатов (мне не ответили).

Из этого можно сделать вывод: исходный код серверной части можно считать закрытым, а значит нам нужно написать свой.

Проводя ресёрч решений по поднятию собственной python-совместимой почты, я наткнулся на старенькую [статью на habr](https://habr.com/ru/articles/143241/) о библиотеке [inbox.py](https://github.com/billzhong/inbox.py), которая позиционирует себя как простой почтовый smtp-сервер для людей.

> Интересный факт: в контрибьюторах библиотеки числится создатель requests (популярной библиотеки для парсинга).

Когда я попытался развернуть сервер на [inbox.py](https://github.com/billzhong/inbox.py), оказалось, что она давно не поддерживается и не может работать с python версии 3.12 и выше.

Логичным решением было [форкнуть](https://github.com/iamlostshe/inboxium) библиотеку, обновив зависимости (переписал на aiosmtpd).

Теперь она работает в современном python (и называется [inboxium](https://github.com/iamlostshe/inboxium)).

Поднял почту на VDS.

Ради интереса решил отправить письмо, просто, по ip (admin@0.0.0.0) - работает. Ни разу не видел чтобы так делали.

После успешной покупки домена и проброса MX записей в DNS мы имеем рабочую почту.

Но проблемы начались с другой стороны:

Для подтверждения почты сервис отправляет сообщение, в формате, который библиотека считает пустым текстом.

Это значит, что нам придётся переписать механизм препарирования сообщений (чтобы пользователь мог получить сырые данные).

И ещё я давно хотел сделать структуру работы с сообщениями как в [aiogram](https://pypi.org/project/aiogram), чтобы был единый класс Message и разработчик мог получить из него всё остальное:

``` python
by: str      | получатель (-и).
sender: str  | отправитель.
subject: str | тема письма.
text: str    | текст письма.
raw: str     | сырой текст письма (для таких случаев как наш).
```

Вот пример кода на обновлённом [inboxium](https://github.com/iamlostshe/inboxium):

``` python
@inbox.message
async def handle(message: InboxMessage) -> None:
    """Handle any messages."""
    if message.sender == TARGET_SENDER:
        print("!!! Верно обнаружен отправитель !!!")

        urls = re.findall(FIND_CONFIDER_URL, message.raw)
        if urls:
            r = requests.get(urls[0])
            print(f"!!! Почта подтверждена {urls[0]} !!!")
```

> Кстати, заметил, что в стандартных классах современного python, связанных с email отвратительное оформление кода. Так что даже в питоне есть еще что форкать))

Для удобства работы, систему было решено сделать автономной: на VDS с белым IP поднят скрипт, который сверяет отправителя и тему письма и автоматически переходит по ссылкам для подтверждения почты.

Обещал способ нивелировать обнаружения временных почт:

Большинство систем, для обнаружения временных почт грубо сверяют домен. поэтому, для минимизации обнаружения нужно поднимать временную почту на домене третьего уровня (user@example.example.com).