---
description: как я разрабатывал собственную временную почту
tags: grey
---

# как я разрабатывал собственную временную почту

мне нужно написать скрипт **авторега аккаунтов** для одного популярного сервиса. для регистрации аккаунтов нужна электронная почта. логичным решением было использовать **временные почты**.

ранее (~1.5 года назад) я уже использовал для таких задач python-библиотеку [tempmail](https://github.com/cubicbyte/tempmail-python), но она [перестала работать](https://github.com/cubicbyte/tempmail-python/issues/13).

в моей [issue](https://github.com/cubicbyte/tempmail-python/issues/13) к [tempmail](https://github.com/cubicbyte/tempmail-python) предложили [альтернативу](https://github.com/MainSilent/MailTm).

но в связи с устаревшими решениями по коду я решил [форкнуть](https://github.com/iamlostshe/mail-tm) либу. оказалось, что механизм библиотеки достаточно прост - она использует [открытые api](https://api.mail.tm/) mail.tm.

проведя небольшой ресёрч в интернете я нашел mail.gw, который выглядит/работает также, как mail.tm и с которым, как оказалось, уже может работать [мой форк](https://github.com/iamlostshe/mail-tm).

но, есть проблема: при регистрации аккаунта сервис легко обнаруживает временные почты (предположительно, по черному списку доменов, но у меня есть решение, расскажу в конце).

значит нам предстоит развернуть собственный сервер временной электронной почты на собственном домене.

исходный код сервера mail.tm и mail.gw (предположительно) был опубликован на GitHub. по крайней мере так было с [документацией](https://docs.mail.tm/), но с 2022 года или ранее недоступен (определил по архивным копиям).

запрос на почты поддержки (support@mail.tm, support@mail.qw), в [дс/тг](https://discord.com/invite/mail) не дал результатов (мне не ответили).

из этого можно сделать вывод: исходный код серверной части можно считать закрытым, а значит нам нужно написать свой.

проводя ресёрч решений по поднятию собственной python-совместимой почты, я наткнулся на старенькую [статью на habr](https://habr.com/ru/articles/143241/) о библиотеке [inbox.py](https://github.com/billzhong/inbox.py), которая позиционирует себя как простой почтовый smtp-сервер для людей.

> интересный факт: в контрибьюторах библиотеки числится создатель requests (популярной библиотеки для парсинга).

когда я попытался развернуть сервер на [inbox.py](https://github.com/billzhong/inbox.py), оказалось, что она давно не поддерживается и не может работать с python версии 3.12 и выше.

логичным решением было [форкнуть](https://github.com/iamlostshe/inboxium) библиотеку, обновив зависимости (переписал на aiosmtpd).

теперь она работает в современном python (и называется [inboxium](https://github.com/iamlostshe/inboxium)).

поднял почту на VDS.

ради интереса решил отправить письмо, просто, по ip (admin@0.0.0.0) - работает. ни разу не видел чтобы так делали.

после успешной покупки домена и проброса MX записей в DNS мы имеем рабочую почту.

но проблемы начались с другой стороны:

для подтверждения почты сервис отправляет сообщение, в формате, который библиотека считает пустым текстом.

это значит, что нам придётся переписать механизм препарирования сообщений (чтобы пользователь мог получить сырые данные).

и ещё я давно хотел сделать структуру работы с сообщениями как в [aiogram](https://pypi.org/project/aiogram), чтобы был единый класс Message и разработчик мог получить из него всё остальное:

``` python
by: str | получатель (-и).
sender: str | отправитель.
subject: str | тема письма.
text: str | текст письма.
raw: str | сырой текст письма (для таких случаев как наш).
```

вот пример кода на обновлённом [inboxium](https://github.com/iamlostshe/inboxium):

``` python
@inbox.message
async def handle(message: InboxMessage) -> None:
    """Handle any messages."""
    if message.sender == TARGET_SENDER:
        print("!!! Верно обнаружен отправитель !!!")

        urls = re.findall(FIND_CONFIDER_URL, message.raw)
        if urls:
            r = requests.get(urls[0])
            print(f"!!! Почта подтверждена {urls[0]} !!!")
```

> кстати, заметил, что в стандартных классах современного python, связанных с email отвратительное оформление кода. так что даже в питоне есть еще что форкать))

для удобства работы, систему было решено сделать автономной: на VDS с белым IP поднят скрипт, который сверяет отправителя и тему письма и автоматически переходит по ссылкам для подтверждения почты.

обещал способ нивелировать обнаружения временных почт:

большинство систем, для обнаружения временных почт грубо сверяют домен. поэтому, для минимизации обнаружения нужно поднимать временную почту на домене третьего уровня (user@example.example.com).